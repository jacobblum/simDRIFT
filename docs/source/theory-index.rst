Theory
==============================

Bloch-Torrey Equation
------------------------------
The self-diffusion process of water spins, as measured by nuclear magnetic resonance (NMR), is modeled by the phenomonlogical Bloch-Torrey Equation (below):

.. math::

   \pdv{\mathbf{M}(\va{r}, t)}{t} = \gamma \left( \mathbf{M} \cp \mathbf{B} \right) - \frac{\mathbf{M}_{x} \vu{i} - \mathbf{M}_{y} \vu{j}}{T_{2}} -\frac{(\mathbf{M}_{z} - M_{0}) \vu{k}}{T_{1}} + \div{\mathbf{D}(\va{r})}\grad{\mathbf{M}}
   
However, analytic solutions to the Bloch-Torrey equation do not exist for complex biophysical systems. To address this problem, we developed this library to provide a framework for biophysically-accurate Monte-Carlo simulations of molecular self-diffusion within biological tissues.

Simulated Diffusion
------------------------------
To sample the diffusion propogator in a realistic manner, we simulate the molecular self-diffusion process for resident spins and calculate the resulting dMRI signal via pulsed gradient spin echo (PGSE) aquisition. The spin diffusion process is modelled via a random walk for each spin in the simulated ensemble. Spins are initially populated uniformly throughout the simulated image voxel. Subsequently, spin positions are updated at each time step under the constraint that they remain in the local environment in which they are initialized. Since the echo times typically used in diffusion magnetic resonance imaging (dMRI) experiments are below the mean preexchange lifetime (:math:`{\tau_i}`) of cellular water, we can safely neglect flux between the simulated microstructural components. The non-exchange of spins between tissue structures is ensured by rejection sampling of proposed steps beyond the relevant structure. At each time step :math:`\dd{t}`, spins are displaced by a distance determined by specified diffusivity of the relevant compartment. Spin displacment directions, :math:`\va{u} \in S^{2}`, are determined using the ``xoroshiro128+`` pseudo-random number generator. Specifically, the displacement of a spin during the :math:`{i^{\mathrm{th}}}` time step is given by

.. math::
    \va{r}_{i} = \va{r}_{i-1} + \left( 6 \mathbf{D}_{0}(\mathrm{local})\dd{t} \right)^{\frac{1}{2}} \vu{u} 

Given the large number of spins required for convergence of the simulated PGSE signal, our code was developed with considerable 
attention towards preformance. To this end, spin trajectories are individually computed on a signle thread of the 
graphical processing unit (GPU), thus allowing for a non-linear relationship between the number of spins populated in the simulated voxel and overall runtime of the simulation. Typical experiements feature :math:`{[0.25,\, 1] \times 10^6}` spins and are completed within :math:`\sim 15` and :math:`60` minutes, depending on the complexity of the simulated microstructure. 

The diffusion process may be simulated for arbitrary geometries characterized by:

    - :math:`N_{\mathrm{fibers}} \in [0,\, 4]` distinct fiber populations, each with user-specified orientations, volume fractions, and intra-axonal diffusivities :math:`\mathbf{D}_{0}`, and 
    - :math:`N_{\mathrm{cells}} \in [0,\, 2]` distinct cell populations, each with user-specified radii and volume fractions.

Simulated Signal Acquisition
------------------------------
Data from the simulated spin trajectories is then used to compute the echo signal produced via PGSE sequence shown below.

.. figure:: PGSE_sequence.png

    (\ **Top**\ ) Pulse sequence generated by radio frequency, or RF, transmission coils. (\ **Middle**\ ) Resultant diffusion gradient. (\ **Bottom**\ ) Spin echo signal measured by RF receive coils.
    

The dMRI signal generated by the :math:`k^{\mathrm{th}}` diffusion gradient :math:`\va{g}_{k}` is calculated via standard numerical integration, which yields the following:

.. math::
    \eval{E(\va{g}_{k}, t)}_{t=TE} = \frac{1}{N_{\text{spins}}} \displaystyle\sum_{i = 1}^{N_{\text{spins}}} \exp\left( -i \sum_{t}^{N_{t}} \gamma \va{g}^{\intercal}_{k}(t) \cdot \va{r}(t) \dd{t} \right)

This signal can subsequently be used for, inter alia, the rapid prototyping, validation, and comparison of models for diffusion in biological tissue. At present, the authors are particularly interesting in evalutating various models of diffusion for their capacity to solve the `inverse problem`: recovery of ground truth intrinsic diffusivities for simulated biophysical structures in realistically-represented tissues.